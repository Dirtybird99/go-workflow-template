name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

# MUST-HAVE #2: Concurrency control
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20  # MUST-HAVE #3: Job timeout
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # MUST-HAVE #1: Caching
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true

      - name: Run integration tests
        run: |
          # Run tests with integration tag
          go test -v -tags=integration -timeout=15m ./...
        env:
          INTEGRATION_TEST: "true"

      # Example: Add service dependencies if needed
      # services:
      #   postgres:
      #     image: postgres:16
      #     env:
      #       POSTGRES_PASSWORD: postgres
      #     ports:
      #       - 5432:5432
      #     options: >-
      #       --health-cmd pg_isready
      #       --health-interval 10s
      #       --health-timeout 5s
      #       --health-retries 5

      # Example: Docker compose for complex setups
      # - name: Start services
      #   run: docker compose -f docker-compose.test.yml up -d

      # - name: Wait for services
      #   run: |
      #     timeout 60 bash -c 'until curl -s http://localhost:8080/health; do sleep 1; done'

      # - name: Cleanup
      #   if: always()
      #   run: docker compose -f docker-compose.test.yml down -v
